#!/bin/bash
set -x

export DEBIAN_FRONTEND=noninteractive

i=0
tput sc
while fuser /var/lib/apt/lists/lock >/dev/null 2>&1 ; do
    case $(($i % 4)) in
        0 ) j="-" ;;
        1 ) j="\\" ;;
        2 ) j="|" ;;
        3 ) j="/" ;;
    esac
    tput rc
    echo -en "\r[$j] Waiting for other software managers to finish..." 
    sleep 0.5
    ((i=i+1))
done 


apt-get update \
&& apt-get -o DPkg::Lock::Timeout=-1 upgrade -y \
&& apt-get install gnupg2 wget curl git -y \
&& wget http://repo.mosquitto.org/debian/mosquitto-repo.gpg.key \
&& apt-key add mosquitto-repo.gpg.key \
&& cd /etc/apt/sources.list.d/ \
&& wget http://repo.mosquitto.org/debian/mosquitto-buster.list \
&& apt-get update \
&& apt-cache search mosquitto \
&& apt-get install mosquitto -y \
&& service mosquitto stop

cat <<EOF > /etc/mosquitto/conf.d/mosquitto.conf
port 8883
cafile /etc/mosquitto/certs/ca.crt.pem
certfile /etc/mosquitto/certs/server.crt.pem
keyfile /etc/mosquitto/certs/server.key.pem
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information
connection_messages true
log_timestamp true
require_certificate true
use_identity_as_username true
acl_file /etc/mosquitto/aclfile
EOF

cat <<EOF > /etc/mosquitto/certs/ca.crt.pem
-----BEGIN CERTIFICATE-----
MIIDpzCCAo+gAwIBAgIUZF2Jr33FtAPXptzdX4Frn07SbnwwDQYJKoZIhvcNAQEL
BQAwYzELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAk5KMSEwHwYDVQQKDBhJbnRlcm5l
dCBXaWRnaXRzIFB0eSBMdGQxEjAQBgNVBAsMCVJvb3QgYXV0aDEQMA4GA1UEAwwH
Um9vdCBDQTAeFw0yMzAyMjQxMjMyMThaFw0yODA4MTYxMjMyMThaMGMxCzAJBgNV
BAYTAlVTMQswCQYDVQQIDAJOSjEhMB8GA1UECgwYSW50ZXJuZXQgV2lkZ2l0cyBQ
dHkgTHRkMRIwEAYDVQQLDAlSb290IGF1dGgxEDAOBgNVBAMMB1Jvb3QgQ0EwggEi
MA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDWe4jyKezmf/iIJAxb9ddXskew
9njxrqBmgSTCDKeM9Wqt1edchyuSdgFznIpypAN+u1kTHZIrPB9+KcIzakiTpGxG
LUIV/Syb1J/dKHv3Ia9fNx9OINwivsh2wHiJBptx5oX35tUr0h3uD4flGpuh70Lt
hyhJT8s/MuGjgbd1kGdebaZKZPMO8KQVrPngYBp642n4QduQdGu/W7/+qNz0VH0C
nAfbY6NnGZ37HSTynKpmmx5Q1tkuCLHB5v1yOrQCAknczX1REsIDGnBNBOpBWuoy
c2w65u3j0lpPW0MLRJlBaf+sti9aTZkLtZtM+X1f/QHJtPv9PqS63s/kRBO1AgMB
AAGjUzBRMB0GA1UdDgQWBBSIDoXEyMT2JPZ+9s0v771Jp6wkvjAfBgNVHSMEGDAW
gBSIDoXEyMT2JPZ+9s0v771Jp6wkvjAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3
DQEBCwUAA4IBAQAz3jLnWpMhBZLu5j5xHBx4rgQlF9bUM+KRn2do4b85Al+D5ZHb
ohgGsrv1R7xSV+AQyM1r6HaRdMqiW6aHdZuX2d1hkCQ23RRbdZZsaicGPYJNq5DZ
kCnqHXry0yd18epiDSSL5rO8Ip41PMyNQKpBW2l3miVANi/XKK8JgO4y4BlFmlSR
G9vUexcd41WYv29yGuL1AI/yqmfLJ+dkKA1OAIX1viOaWMvYQyPFbXtbUFzdu3I7
L25DlHwiE8WHolAsDY8BMKmeh+Le1bueHyKCPDWofODNlliunJ3MdnYrvIRONImX
APtplG0CKr8Kd843T6cco08UqhMa8+qdtjKx
-----END CERTIFICATE-----
EOF

cat <<EOF > /etc/mosquitto/certs/server.crt.pem
-----BEGIN CERTIFICATE-----
MIIDVDCCAjwCFFCGOVogl2LVYp21APd9sSwVjz+qMA0GCSqGSIb3DQEBCwUAMGMx
CzAJBgNVBAYTAlVTMQswCQYDVQQIDAJOSjEhMB8GA1UECgwYSW50ZXJuZXQgV2lk
Z2l0cyBQdHkgTHRkMRIwEAYDVQQLDAlSb290IGF1dGgxEDAOBgNVBAMMB1Jvb3Qg
Q0EwHhcNMjMwMjI4MTYwNDI3WhcNMjUwMTI4MTYwNDI3WjBqMQswCQYDVQQGEwJV
UzELMAkGA1UECAwCTkoxDjAMBgNVBAcMBUVhcnRoMRIwEAYDVQQKDAlIdWRzb25J
c2UxDDAKBgNVBAsMA0NTRTEcMBoGA1UEAwwTbXF0dDEuaHVkc29uaXNlLmNvbTCC
ASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMfUui4qT5maQ/aW3zZy1VHR
f/i071eXEByvf6Rmc1qt9mRLYbiQPWAHHOVvZ9T8oKXy1jHxnELJQSFNI+Z3zASu
5oimJsWe4h9Ja/TVyQVUioH61IpAQr5Q+dWg+uiMf0Bvm6e24vHrtAdMVI6QYGAI
Z1JAVivp6bhgORGr0cmjnTsTd6DfNGSfONVuSf41//FoCtELGhEbFoeBo8Tu3epm
kAHBIh8Kg24615IyCzQ/qE3XfFY7MecGZxZ9hMgQPfi4zpC/kq4xsX84+aNGx6Bv
8ZPgoRR1koCwXVN/RHEF9JD5lPGFtE/SZhDvEdrFqOGvyWK7X+ZvE5rUYgUiMFUC
AwEAATANBgkqhkiG9w0BAQsFAAOCAQEAGjFm8muqPyB/RFeIcmBLS7ThTO7d+gyA
7fpaJJC9xQTPU/5WIRJnZqao8H602a6JcgaEjnQf6QbqZNcGjPaMWfJd5Rs5uuGS
3MwO2jk16uy4GIagkVdITYUH/ggDo8Dh/rt3sqjQfpKtjpbk0GnzsdvIiuVJXzhg
G91ypYSQODOu8JXwzfAHvismRRF6Yga9qgrXLAXeD9zvlJSL/l49fsM4R7jA01WC
qNx1cL4YbTIoFJY+Lzp2JhhyqMfN/tYofEmQy9Hs1TwF0oh3E09OvheajSXiCoCS
8mI3GnIMLQ78PWT+zj8DBJew71dLiq/btvdRX6irOHqH8IoOwvjyiw==
-----END CERTIFICATE-----
EOF

cat <<EOF > /etc/mosquitto/certs/server.key.pem
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAx9S6LipPmZpD9pbfNnLVUdF/+LTvV5cQHK9/pGZzWq32ZEth
uJA9YAcc5W9n1PygpfLWMfGcQslBIU0j5nfMBK7miKYmxZ7iH0lr9NXJBVSKgfrU
ikBCvlD51aD66Ix/QG+bp7bi8eu0B0xUjpBgYAhnUkBWK+npuGA5EavRyaOdOxN3
oN80ZJ841W5J/jX/8WgK0QsaERsWh4GjxO7d6maQAcEiHwqDbjrXkjILND+oTdd8
Vjsx5wZnFn2EyBA9+LjOkL+SrjGxfzj5o0bHoG/xk+ChFHWSgLBdU39EcQX0kPmU
8YW0T9JmEO8R2sWo4a/JYrtf5m8TmtRiBSIwVQIDAQABAoIBAHK+tCnOIecRrfTq
rUGWrudMZS9qtgSVuaq/G4xLR/HJ8rGkl3hjWtrJOs6EKhsi9RxVVKlZE2FGLx/w
K60rHPuTcs0Emz7e/Pj6MANmvwdQhDgez+yS+cBOvybsSSc/hdJ6Q+cKHUbNEZMf
QW6beLusF6gjSVft+Ubl+d8rykr9pIq6bYuag+kuU+4cgOX95w+ENxkI4GSt1S1r
JE0lK8sYHaLOh0Sll+ZHFkIly4MMUzMaAZD1YOB4N3Yin/7HzU2N6GWWhycxp8Cp
s6aHCvSdybXEUgE4zOsYYfCs2r3ThhddtSn8fnqT+eKXH59wrw17ecYIdQJjVgWK
2NJgoAECgYEA4n4FJrzIrowqj2a1FNdolt0D9V87zh/gYqvdvoQBEuSpBkW1Y9db
7Uk9HZBou3DbRq1cLGliG9aC5odehhBYpr7EZiZk+c+uGJeyAyk4R+PZSkH1xEif
sgvNwUQxmlFNRFlw/Lz5BfNRPr+1YsQIOaf14jA6vQJgHStCqiZtZCkCgYEA4d1/
kNmVi+pmUGw3lOq6mcARwMhzCsL7nXfv9ygMUTmF9+szgvBNTcqoarTAgtwL2VvS
B1xdiUo/a8f6ReRKOsgjD68me7bxpTAdroeW3q2CM9AUmwRcT6sNn3ss7w7czDl3
h5vUrY0kD98KpgKaEhFh6H4+Dso0rJRaOBtEkE0CgYEApLMxOcckQ9GHjXoJihtO
Yg5cN41GJxEFEZubB1Rkl4GR7A665dyQa4/LknkVv+BEhDPCiEUl48psrAiaUvEG
FlM47HNVEFfWaOm+uA+8boKg2x/2AQMypb1xpO3bCDXA80f7Ir6kc5BJb1DnLOgS
dyLNaerae+GDVRLFSofhGmkCgYEA2RSV4pX9UXh71Zfs48emiNc9ONhvGUzFoFcB
374x+G8c/2ajH5nt8nJw4/3NePgcu0+w0TpI/AbMZb7SIBKF9XEdoZlpl0YBgg54
uKHAs0x382xuIX9TaY6xjTJJwYm7VN12sHNpOVSJ8GciSOP/SJZET7vl0Tku3x/G
hl5Oy5ECgYBimXRYsURdPQWzW7BctBgsyWZMRWgd2Q3bjNDWQ5bc8SuBIs4K/I7k
kMOZ9s74SU+MZcztn83yKG6LkGUwEAEqDBfzQEYEIuUrsHhGE6bDS6EZXPKn2bJP
sLQuS4b6ibFOF5Nrfg4OUHJ0dVj2K6OIRaSkOpsykx5Y+D0LL+e6iQ==
-----END RSA PRIVATE KEY-----
EOF

cat <<EOF > /etc/mosquitto/aclfile
user admin
topic readwrite \$dps/registrations/PUT/#
topic readwrite \$dps/registrations/GET/#
topic readwrite \$dps/registrations/res/#

pattern readwrite \$dps/registrations/PUT/iotdps-register/%u/#
pattern readwrite \$dps/registrations/GET/iotdps-get-operationstatus/%u/#
pattern read \$dps/registrations/res/%u/#
EOF

service mosquitto start \
&& cd /home/azureuser \
&& mkdir /home/azureuser/app ||: \
&& cd app \
&& chown -R azureuser:azureuser .
